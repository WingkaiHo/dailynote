####测试ambassador API gateway性能测试
---

**原生环境和ambassador对比**

通过https://github.com/BuoyantIO/strest-grpc工具模拟

1） 服务器端模拟工作负载0m请求(所有请求立刻返回)

| P(x)| k8s 原生网络延迟 | ambassador api gateway| 相差 |
|--------|--------|--------|--------|
| p50 | 125us | 547us  | 422us |
| p75 | 134us | 610us  | 476us |
| p90 | 146us | 661us  | 515us |
| p95 | 157us | 673us  | 516us |
| p99 | 295us | 1682us | 1387us|
以上测试成功率100%

以p95为标准总结
- 增加延迟： 516us(0.5ms)
- 增加延迟比例： 328%

2）服务器端模拟工作负载10m请求(模拟1请求耗10ms)

由于实际api请求处理都是有一定时间，不可能为0ms这种理想情况，模拟一个请求处理时间为10ms

| P(x)| k8s 原生网络延迟 | ambassador api gateway| 相差 |
|--------|--------|--------|--------|
| p50 | 5491us | 5903us  | 412us |
| p75 | 7543us | 8071us  | 528us |
| p90 | 9423us | 9919us  | 496us |
| p95 | 9519us | 10007us  | 488us |
| p99 | 9591us | 10143us | 552us |
以上测试成功率100%

以p95为标准总结
- 增加延迟： 488us(0.5ms)
- 增加延迟比例： 5.1%

**不同并发压力性能对比**

同样服务器端模拟每个请求消耗10ms时间

1) strest-grpc-server单实例， 单连接

| P(x)| 1000qps | 2000qps | 4000qps | 8000qps |
|--------|--------|--------|--------|--------|
| p50 | 5439us | 5435us  | 5511us | 4643us |
| p75 | 7591us | 7579us  | 7579s |  7595us |
| p90 | 9447us | 8663us  | 9375us | 9479us |
| p95 | 9591us | 9583us  | 9591us | 9591us |
| p99 | 9639us | 9639us | 9639us |  9631us |

由于是单个连接，qps效果不大。

2）strest-grpc-server单实例， 300连接不同qps

| P(x)| 1000qps | 2000qps | 4000qps | 8000qps |
|--------|--------|--------|--------|--------|
| p50 | 6163us | 6175us  | 5883us | 6139us |
| p75 | 8679us | 8703us  | 8519s |  8735us |
| p90 | 10295us | 10319us  | 9967us | 10287us |
| p95 | 11647us | 11783us  | 11023us | 11527us |
| p99 | 15735us | 14943us | 14103us |  14519us |

3) strest-grpc-server单实例， 1000连接不同qps

| P(x)| 4000qps | 8000qps |
|--------|--------|--------|
| p50 | 11799us | 11791us  |
| p75 | 33631us | 15871us  |
| p90 | 2310391us | 223743us  |
| p95 | 241023us | 431359us  |
| p99 | 445439us | 859135us  |

grpc-server 单实例压力测试总结
- 连接数目： 1000以上
- 并发数目： 4000qps以上


3) 通过ammbassador解决压力

grpc-server实例增加3个， 使用单个通过ammbassador实例， 连接数目1000在不同qps下表现

| P(x)| 4000qps | 8000qps |
|--------|--------|--------|
| p50 | 25535us | 24415us  |
| p75 | 43517us | 493121us  |
| p90 | 70975us | 84991us  |
| p95 | 95939us | 232063us  |
| p99 | 243199us | 276735us  |

在p95/p99减少一半响应速度， 达到负载居衡效果

**单实例和负载均衡不同连接数延迟对比**


| 模式| 100连接 | 200连接 | 400连接 | 800连接 | 1000连接 |
|--------|--------|--------|--------|--------|--------|
| 单实例 | p50: 5ms, p75: 7ms p95: 10ms | p75: 6ms, p75: 9ms, p95: 11ms| p50: 7ms, p75: 9ms, p95: 55ms | p50 11ms, p75: 16ms, p95: 233ms | p50: 10ms, p75: 14ms, p95: 364ms |
| 3实例3负载均衡器 | p50: 6ms, p75: 8ms, p95: 10ms  | p50: 6ms, p75: 9ms, p95: 13ms | p50: 11ms, p75: 16ms, p95: 47ms | p50: 23ms, p75: 41ms, p95: 164ms | p50: 19ms, p75: 37ms, p95: 192ms |


####测试总结

- 在高并发，多连接gpc测试ammbassador基本可以达到100%正常返回
- 在高并发，多连接gpc测试通过ammbassador api gateway负载均衡明显减少响应速度
- 负载均衡： 应用不需要编写负载均衡代码，只需直连接服务ip方式达到。
- 延迟增加： 增加0.5~1ms延迟，实时性比较高程序(返回响应时间2ms以内)应用不适合使用，对于大部份应用适合

####总结

可以引入ammbassador解决:

- 支持内部grpc通信负载均衡问题， 解决k8s service不能支持gprc长连接负载均衡 【符合预期】
- 基于grpc服务名称前缀转发: grpc 每个为服务都有一个服务名称，在.proto文件里面定义减少app grpc服务地址配置。(测试服务需要配置其它的服务前缀进行区别) 【符合预期】
- 负载均衡: grpc服务实现负载均衡能够全局底层架构上实现，不用在每个应用里面实现 【符合预期】
- 结合k8s服务健康检查机制: 当服务检查不通过的时候，k8s自动把实例踢出负载均衡列表 【符合预期】
- 灰度发布： 负载均衡器级别灰度(k8s只能实现实例级别) 【符合预期】


####常见问答

**http负载居衡是否适合**

ammbassador api gateway也支持http， 但是http是端连接，k8s集群内部的http通信， k8s service L4负载均衡器就可以达到效果，没有必要多转一层。


**k8s集群外部应用访问内部gprc是否可以负载均衡**

通过Nodeport访问ammbassador apigatwway。 由于目前nginx ingress controller底层nginx不支持grpc/http2不能使用域名方式访问，只能通过nodeport方式访问ammbassador apigatwway, 转发对于上游grpc服务，实现负载均衡。

**ammbassador和客户端实现负载均衡区别**

客户端： 无法全局负载均衡， 优点延迟少
ammbassador: 可以通过envoy优化负载均衡，客户端配置更加简单，缺点: 增加网络流量，延时。所有请求先到ammbassador api gatway，再转发上游实例

**ammbassador grpc 速率限制**

ammbassador只有在收费pro版本支持grpc全局速率限制配置